<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:insert="~{common_fragments :: head}"></head>
<body>
<div th:insert="~{common_fragments :: mainHeader}"></div>

<!-- Solar system loading -->
<div class="cosmic-loader-overlay" id="cosmicLoader">
    <div class="stars" id="starsContainer"></div>
    <div class="loader-content-space">
        <div class="orbit-system">
            <div class="sun"></div>
            <div class="orbit orbit-1">
                <div class="planet planet-1"></div>
            </div>
            <div class="orbit orbit-2">
                <div class="planet planet-2"></div>
            </div>
            <div class="orbit orbit-3">
                <div class="planet planet-3"></div>
            </div>
        </div>
        <div class="loading-text">Exploring Space...</div>
        <div class="progress-container-loader">
            <div class="progress-bar-loader" id="progressBar"></div>
        </div>
        <div class="loading-percentage" id="loadingPercentage">0%</div>
    </div>
</div>

<!-- 3D Canvas Container -->
<div id="space-container" class="position-relative">
    <canvas id="three-canvas"></canvas>

    <div id="planet-popup" class="popup">
        <div class="popup-content">
            <span id="popup-close">&times;</span>
            <h4 id="popup-title"
                style="margin-bottom: 7px; font-family: 'Orbitron', monospace; font-weight: bold; color: rgba(255, 215, 0, 0.9)"></h4>
            <p id="popup-entity-description"></p>
            <p><strong>Distance:</strong> <span id="popup-distance"></span></p>
            <p><strong>Gravity:</strong> <span id="popup-gravity"></span></p>
            <button class="btn btn-sm" id="btn-view-mission">
                VIEW MISSION
            </button>
        </div>
    </div>

    <div th:insert="~{popup-mission :: mission-popup}"></div>
    <div th:insert="~{popup-mission :: mission-popup-script}"></div>

    <div id="map-container" style="position: relative; display: inline-block;">
        <canvas id="space-map"></canvas>

        <!-- Info Panel -->
        <div class="info-panel">
            <div class="panel-content bg-dark bg-opacity-90 p-3 rounded border border-info">
                <div id="planet-info">

                    <h5 class="space-explorer text-info mb-3" style="font-family: 'Orbitron', monospace">
                        3D Space Explorer
                    </h5>
                    <div class="info-text small mb-3">
                        <p class="mb-2">Click on any planet to explore its details.</p>
                        <div><strong>Click & drag</strong> - Rotate camera</div>
                        <div><strong>Mouse wheel</strong> - Zoom in/out</div>
                        <div><strong>Click planet</strong> - Select and explore</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stats Panel -->
        <div class="stats-panel">
            <div class="panel-content bg-dark bg-opacity-90 p-3 rounded border border-info">
                <div class="small">
                    <div class="mb-1">Destinations: <span class="text-warning" id="destination-count">0</span></div>
                    <div class="mb-1">Selected: <span class="text-success" id="selected-planet">None</span></div>
                </div>
            </div>
        </div>
    </div>
</div>

<div th:insert="~{common_fragments :: mainFooter}"></div>

<script>
    function createStars() {
        const starsContainer = document.getElementById('starsContainer');
        const starCount = 100;
        const fragment = document.createDocumentFragment();

        for (let i = 0; i < starCount; i++) {
            const star = document.createElement('div');
            star.className = 'star';
            star.style.cssText = `
            width: ${Math.random() * 3}px;
            height: ${Math.random() * 3}px;
            left: ${Math.random() * 100}%;
            top: ${Math.random() * 100}%;
            animation-delay: ${Math.random() * 3}s;
        `;
            fragment.appendChild(star);
        }

        for (let i = 0; i < 3; i++) {
            const shootingStar = document.createElement('div');
            shootingStar.className = 'shooting-star';
            shootingStar.style.cssText = `
            left: ${Math.random() * 100}%;
            top: ${Math.random() * 50}%;
            animation-delay: ${Math.random() * 5}s;
        `;
            fragment.appendChild(shootingStar);
        }

        starsContainer.appendChild(fragment);
    }

    function simulateLoading() {
        const progressBar = document.getElementById('progressBar');
        const loadingPercentage = document.getElementById('loadingPercentage');
        const loader = document.getElementById('cosmicLoader');

        let progress = 0;
        const duration = 2000;
        const interval = 50;
        const increment = (interval / duration) * 100;

        const progressInterval = setInterval(() => {
            progress += increment;
            if (progress >= 100) {
                progress = 100;
                clearInterval(progressInterval);
                setTimeout(() => {
                    loader.classList.add('fade-out');
                    setTimeout(() => {
                        loader.style.display = 'none';
                    }, 500);
                }, 300);
            }

            progressBar.style.width = progress + '%';
            loadingPercentage.textContent = Math.floor(progress) + '%';
        }, interval);
    }

    createStars();
    simulateLoading();
</script>

<!-- 1. INLINE DATA (comes straight from Thymeleaf) -->
<script th:inline="javascript">
    /*<![CDATA[*/
    const DESTINATIONS_DATA = /*[[${destinations}]]*/ [];
    console.log('Thymeleaf data loaded:', DESTINATIONS_DATA.length, 'destinations');
    console.log('Sample destination:', DESTINATIONS_DATA[0]);
    /*]]>*/
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

<script th:src="@{/js/space-map.js}"></script>


</body>
</html>