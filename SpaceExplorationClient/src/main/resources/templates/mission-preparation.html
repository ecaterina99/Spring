<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:insert="~{common_fragments :: head}"></head>
<body>
<div th:insert="~{common_fragments :: mainHeader}"></div>

<main class="container py-4">

    <section class="mission-participants-text text-md-start mb-4">
        <h1 class="display-5 fw-bold pt-3">
            MISSION PREPARATION FOR
            <span th:text="${mission.name.toUpperCase()}" style="color: #ffd500"></span><br>
        </h1>
        <h2 class="display-7 fw-bold">DESTINATION: <span th:text="${ mission.destinationName.toUpperCase()}"
                                                         style="color: #ffd500"></span></h2>
        <p><span th:text="${mission.code}"></span></p>

        <p  class="d-flex pb-3" style="color: #ffffff; line-height: 1.8; margin-top: 10px; font-size: 18px;">
            ‚ùó Please pay attention to the specializations required for this mission and crew number.<br>
            Meeting all the required specialization and crew requirements greatly
            increases your chances of success.<br>Otherwise, the risk of mission failure will rise.
        </p>
        <p style="font-size: 20px; color: #d9534f"><strong>Required specializations: </strong>
            <strong><span style="color: #ffd500"
        th:text="${#strings.arrayJoin( mission.specializations.![specialization.displayName + ' - ' + quantity],
    ', ' )}"></span></strong>
        </p>
    </section>

    <!--  Mission details -->
    <section class="mission-participants-container pt-0 pb-3">

        <div class="mission-participants-text text-start mb-4">
            <h2 class="display-7 fw-bold text-glow">CREATE MISSION CREW</h2>
        </div>

        <div class="d-flex align-items-center position-relative">

            <button class="btn btn-light shadow position-absolute start-0 z-3 scroll-btn" id="scrollLeft">
                <i class="bi bi-chevron-left"></i>
            </button>

            <div class="scroll-container d-flex overflow-hidden" id="astronautsScroll">
                <div class="d-flex flex-nowrap gap-4 p-2">

                    <div class="card-participants text-center border-0 flex-shrink-0"
                         style="width: 200px; height: 350px;"
                         th:each="astronaut : ${astronauts}">

                        <div class="card-participants-img text-center border-0 pb-2">
                            <img th:src="@{${astronaut.imageUrl}}" class="mission-participants-card-img-top rounded"
                                 alt="image">
                        </div>

                        <div class="card-participants-body text-center">
                            <h6 class="card-participants-title fw-bold" style="color: #162271;"
                                th:text="${astronaut.firstName.toUpperCase() + astronaut.lastName.toUpperCase()}"></h6>
                            <p class="text-muted"><strong><span th:text="${astronaut.specialization.getDisplayName()}"
                                                                class="text-specialization"></span></strong>
                            </p>
                            <button class="btn hero-btn pt-0 " id="btn-view-participants"
                                    th:attr="data-id=${astronaut.id},
                     data-firstname=${astronaut.firstName},
                     data-lastname=${astronaut.lastName},
                     data-specialization=${astronaut.specialization.getDisplayName().toUpperCase()},
                     data-image=@{${astronaut.imageUrl}},
                     data-experience=${astronaut.yearsOfExperience},
                     data-birthdate=${astronaut.dateOfBirth},
                     data-phone=${astronaut.phone},
                     data-health=${astronaut.healthStatus.getDisplayName()},
                     data-fitness=${astronaut.fitnessScore},
                     data-education=${astronaut.educationScore},
                     data-psychological=${astronaut.psychologicalScore},
                     data-overall=${astronaut.overallScore},
                     data-rate=${astronaut.dailyRate}"
                                    onclick="showPopup(this)">
                                <strong>VIEW DETAILS</strong>
                            </button>
                            <button class="btn hero-btn pt-0 btn-add-participants"
                                    th:attr="data-astronaut-id=${astronaut.id}, data-mission-id=${mission.id}, data-crew-size=${mission.crewSize} ">
                                <strong>ADD TO CREW</strong>
                            </button>
                        </div>
                    </div>
                </div>
            </div>


            <button class="btn btn-light shadow position-absolute end-0 z-3 scroll-btn" id="scrollRight">
                <i class="bi bi-chevron-right"></i>
            </button>

        </div>
    </section>

    <div class="participants-and-risks-container">
        <section class="participants-and-risks">
            <!-- PARTICIPANTS SECTION -->
            <div class="participants">
                <!-- Decorative cosmic dots -->
                <div class="cosmic-dot" style="top: 10%; left: 15%; animation-delay: 0s;"></div>
                <div class="cosmic-dot" style="top: 30%; left: 80%; animation-delay: 1s;"></div>
                <div class="cosmic-dot" style="top: 60%; left: 25%; animation-delay: 2s;"></div>
                <div class="cosmic-dot" style="top: 85%; left: 70%; animation-delay: 1.5s;"></div>

                <h2 class="section-header">‚ö° MISSION CREW</h2>


                <div th:if="${#lists.isEmpty(participants)}">
                    <p class="lead" style="color: #fafafa; line-height: 1.8; margin-top: 10px;">
                        No participants assigned yet.<br>
                        Add crew members to begin mission preparation.</p>
                <br>
                </div>
                <div class="text-center mb-3" id="clear-crew-btn-container" style="display:none;">
                    <button class="btn-clear" onclick="clearCurrentMissionCrew()">
                        <i class="bi bi-trash"></i> Clear All
                    </button>
                </div>
            </div>

            <!-- RISKS SECTION -->
            <div class="risks">
                <h2 class="section-header">‚ö†Ô∏è CHECK MISSION RISKS</h2>

                <div class="risk-info">
                    <div class="risk-info-header d-flex gap-5 justify-content-start align-items-end">
                        <img th:src="@{${mission.imgUrl}}" class="card-image" style="max-height: 170px" alt="image">

                        <div class="risk-issues d-flex justify-content-center">
                    <p style="font-size: 22px">
                        <strong>Potential Issues:</strong>
                    </p>
                        </div>
                    </div>
                    <p style="color: #ffcc80; line-height: 1.8; margin-top: 10px; text-align: justify;">
                        ‚ö° <span th:text="${mission.getPotentialIssues()}" class="lead" style="color:#ffd500;"></span>
                    </p>
                </div>

                <div style="text-align: center; margin-top: 25px;">
                    <button class="btn-check-risks"
                            th:attr="data-mission-id=${mission.id},
                 data-crew-size=${mission.crewSize}
                           "
                            onclick="showRisksPopup(this)">
                        ANALYZE RISKS
                    </button>
                </div>
            </div>
        </section>
    </div>


    <!--  Back button -->

    <div class="start-mission d-flex flex-wrap gap-3 justify-content-center ">
        <br>
        <button class="btn-start-mission ">
        <span>START MISSION</span>
        </button>
        <br>
    </div>


    <!-- Popup risks-->
    <div  id="popup-risks" class="astronaut-popup" style="display:none; height: 700px">
        <div class="popup-content" style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
         border-radius: 15px; padding: 30px; max-width: 700px; height: 700px; color: white;
         box-shadow: 0 10px 50px rgba(0, 212, 255, 0.3); overflow-y: auto;">

            <div class="popup-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="color: #ffd500; margin: 0;">üõ∏ MISSION RISK ANALYSIS</h3>
                <button id="popup-risks-close" style="background: transparent; border: none;
                    color: #ff6b6b; font-size: 28px; cursor: pointer; line-height: 1;">
                    √ó
                </button>
            </div>

            <div id="risk-analysis-content">


            </div>
        </div>
    </div>


    <!-- Popup -->
    <div id="astronaut-popup" class="astronaut-popup" style="display:none;">
        <div class="astronaut-popup-content">
            <span id="popup-close">&times;</span>

            <br>
            <h3 id="popup-title" class="popup-header"><strong>ASTRONAUT BIOGRAPHY</strong></h3>


            <div class="astronaut-top d-flex">
                <div class="astronaut-image">
                    <img id="astronaut-img" class="astronaut-img rounded" alt="astronaut">
                </div>
                <div class="astronaut-main-info">
                    <h3 id="popup-name" class="popup-name"></h3>
                    <p><strong><span id="popup-specialization"></span></strong></p>
                </div>
            </div>

            <div class="astronaut-info row mt-2">
                <div class="col-md-6 score-info-astronaut">
                    <h5 class="popup-subtitle"><strong>MAIN INFO</strong></h5>
                    <p><strong>Date of birth:</strong><span id="popup-birthDate"></span></p>
                    <p><strong>Years of experience:</strong> <span id="popup-experience"></span></p>
                    <p><strong>Phone:</strong> <span id="popup-phone"></span></p>
                    <p><strong>Status:</strong> <span id="popup-status"></span></p>
                    <p><strong>Daily rate:</strong> <span id="popup-rate"></span></p>
                </div>

                <div class="col-md-6 score-info-astronaut">
                    <h5 class="popup-subtitle"><strong>ASTRONAUT SCORE</strong></h5>
                    <p><strong>Fitness score:</strong> <span id="popup-fitness"></span></p>
                    <p><strong>Education score:</strong> <span id="popup-education"></span></p>
                    <p><strong>Psychological score:</strong> <span id="popup-psychological"></span></p>
                    <p><strong>Overall score:</strong> <span id="popup-overall"></span></p>
                </div>
            </div>

            <div class="text-center mt-1">
                <button id="downloadBtn" class="btn btn-outline-info btn-sm">
                    DOWNLOAD BIOGRAPHY
                </button>

            </div>
        </div>
    </div>
</main>
<div id="alert-container" class="position-fixed top-0 start-50 translate-middle-x mt-3" style="z-index: 2000;"></div>

<div th:insert="~{common_fragments :: mainFooter}"></div>


<script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', () => {
        /*<![CDATA[*/
        const accessToken = /*[[${accessToken}]]*/ '';
        const userId = /*[[${userId}]]*/ '';
        /*]]>*/
        const storedUserId = sessionStorage.getItem('currentUserId');

        if (storedUserId && storedUserId !== userId.toString()) {
            console.log('Different user detected, clearing session data');
            Object.keys(sessionStorage).forEach(key => {
                if (key.startsWith('user_')) {
                    sessionStorage.removeItem(key);
                }
            });
        }

        if (userId) {
            sessionStorage.setItem('currentUserId', userId);
        }
        if (accessToken) {
            sessionStorage.setItem('accessToken', accessToken);
        }
        if (!sessionStorage.getItem('allMissionCrews')) {
            sessionStorage.setItem('allMissionCrews', JSON.stringify({}));
        }
        initializeUserMissionData(userId);

        displayCurrentCrew();
        displayCrewMembers();

    });

    function initializeUserMissionData(userId) {
        const userDataKey = `user_${userId}_missions`;
        if (!sessionStorage.getItem(userDataKey)) {
            sessionStorage.setItem(userDataKey, JSON.stringify({}));
        }
    }

    function getUserMissionData() {
        const userId = sessionStorage.getItem('currentUserId');
        const userDataKey = `user_${userId}_missions`;
        return JSON.parse(sessionStorage.getItem(userDataKey) || '{}');
    }

    function saveUserMissionData(data) {
        const userId = sessionStorage.getItem('currentUserId');
        const userDataKey = `user_${userId}_missions`;
        sessionStorage.setItem(userDataKey, JSON.stringify(data));
    }

    document.querySelectorAll(".btn-add-participants").forEach(btn => {
        btn.addEventListener("click", () => {
            const astronautId = btn.getAttribute("data-astronaut-id");
            const missionId = btn.getAttribute("data-mission-id");
            const crewSize = btn.getAttribute("data-crew-size");

            let userMissions = getUserMissionData();
            let currentMissionCrew = userMissions[`mission_${missionId}_crew`] || [];

            if (currentMissionCrew.some(member => member.astronautId === astronautId)) {
                showAlert("This astronaut is already in the crew!", "warning");
                return;
            }

            if (currentMissionCrew.length >= crewSize) {
                showAlert("Mission crew is full!", "warning");
                return;
            }

            const viewBtn = btn.previousElementSibling;

            currentMissionCrew.push({
                astronautId: astronautId,
                missionId: missionId,
                firstName: viewBtn.getAttribute('data-firstname') || '',
                lastName: viewBtn.getAttribute('data-lastname') || '',
                specialization: viewBtn.getAttribute('data-specialization') || '',
                overallScore: viewBtn.getAttribute('data-overall') || '0',
                healthStatus: (btn.getAttribute('data-health') || 'UNKNOWN').trim().toUpperCase()
            });

            userMissions[`mission_${missionId}_crew`] = currentMissionCrew;
            saveUserMissionData(userMissions);

            btn.textContent = "ADDED ‚úì";
            btn.disabled = true;
            btn.classList.add('btn-success');

            showAlert("Astronaut added to crew!", "success");
            displayCurrentCrew();
            displayCrewMembers();

        });
    });

    function displayCurrentCrew() {
        const missionId = document.querySelector('.btn-add-participants')?.getAttribute('data-mission-id');
        if (!missionId) {
            console.warn('Mission ID not found');
            return;
        }

        const currentMissionCrew = getMissionCrew(missionId);

        const crewCount = document.getElementById('crew-count');
        if (crewCount) {
            crewCount.textContent = `Crew members: ${currentMissionCrew.length}`;
        }

        document.querySelectorAll(".btn-add-participants").forEach(btn => {
            const astronautId = btn.getAttribute("data-astronaut-id");
            const isAdded = currentMissionCrew.some(member => member.astronautId === astronautId);

            if (isAdded) {
                btn.textContent = "ADDED ‚úì";
                btn.disabled = true;
                btn.classList.add('btn-success');
            } else {
                btn.textContent = "ADD TO CREW";
                btn.disabled = false;
                btn.classList.remove('btn-success');
            }
        });
    }
    function displayCrewMembers() {
        const missionId = document.querySelector('.btn-add-participants')?.getAttribute('data-mission-id');
        if (!missionId) return;

        const crew = getMissionCrew(missionId);
        const participantsDiv = document.querySelector('.participants');
        const clearBtnContainer = document.getElementById('clear-crew-btn-container');

        let emptyMessageDiv = participantsDiv.querySelector('div[th\\:if]') ||
            participantsDiv.querySelector('.lead')?.parentElement;
        let crewCardsContainer = participantsDiv.querySelector('.added-crew-card');

        if (crew.length === 0) {
            if (crewCardsContainer) {
                crewCardsContainer.remove();
            }

            if (emptyMessageDiv) {
                emptyMessageDiv.style.display = 'block';
            }

            if (clearBtnContainer) {
                clearBtnContainer.style.display = 'none';
            }
            return;
        }

        if (emptyMessageDiv) {
            emptyMessageDiv.style.display = 'none';
        }

        if (!crewCardsContainer) {
            const header = participantsDiv.querySelector('.section-header');
            crewCardsContainer = document.createElement('div');
            crewCardsContainer.className = 'added-crew-card d-flex flex-wrap gap-3';
            header.after(crewCardsContainer);
        } else {
            crewCardsContainer.style.display = 'flex';
        }

        if (clearBtnContainer) {
            clearBtnContainer.style.display = crew.length > 0 ? 'block' : 'none';
        }

        crewCardsContainer.innerHTML = crew.map(member => `
        <div class="added-crew-card p-3 flex-fill text-center position-relative">
            <button class="btn btn-sm btn-danger position-absolute top-0 end-0 m-2"
                    onclick="removeFromCrew('${member.astronautId}', '${missionId}')"
                    style="padding: 2px 6px; font-size: 12px; z-index: 10;">
                <i class="bi bi-x-lg"></i>
            </button>
            <h5 class="fw-bold" style="color:#ffd500;">
                ${member.firstName.toUpperCase()} ${member.lastName.toUpperCase()}
            </h5>
            <p>
                <span style="color: #00d4ff;">‚ñ∏</span>
                Specialization:
                <span style="color: white;">${member.specialization.toLowerCase()}</span>
            </p>
            <span class="score">Overall score: <span>${member.overallScore}</span></span>
        </div>
    `).join('');
    }


    function getMissionCrew(missionId) {
        let userMissions = getUserMissionData();
        return userMissions[`mission_${missionId}_crew`] || [];
    }

    function clearCurrentMissionCrew() {
        const missionId = document.querySelector('.btn-add-participants')?.getAttribute('data-mission-id');
        if (!missionId) {
            showAlert("Mission ID not found!", "danger");
            return;
        }

        clearMissionCrew(missionId);

        document.querySelectorAll(".btn-add-participants").forEach(btn => {
            btn.textContent = "ADD TO CREW";
            btn.disabled = false;
            btn.classList.remove('btn-success');
        });
    }

    function clearMissionCrew(missionId) {
        let userMissions = getUserMissionData();
        delete userMissions[`mission_${missionId}_crew`];
        saveUserMissionData(userMissions);
        displayCurrentCrew();
        displayCrewMembers();
        const crewCardsContainer = document.querySelector('.added-crew-card');
        if (crewCardsContainer) {
            crewCardsContainer.remove();
        }
        const emptyMessageDiv = document.querySelector('.participants .lead')?.parentElement;
        if (emptyMessageDiv) {
            emptyMessageDiv.style.display = 'block';
        }
        const clearBtnContainer = document.getElementById('clear-crew-btn-container');
        if (clearBtnContainer) {
            clearBtnContainer.style.display = 'none';
        }
        document.getElementById('btn-clear')?.style.setProperty('display', 'none', 'important');
    }

    function removeFromCrew(astronautId, missionId) {
        let userMissions = getUserMissionData();
        let currentMissionCrew = userMissions[`mission_${missionId}_crew`] || [];

        currentMissionCrew = currentMissionCrew.filter(member => member.astronautId !== astronautId);
        userMissions[`mission_${missionId}_crew`] = currentMissionCrew;
        saveUserMissionData(userMissions);

        displayCurrentCrew();
        displayCrewMembers();
        showAlert("Astronaut removed from crew", "info");

        document.querySelectorAll(".btn-add-participants").forEach(btn => {
            if (btn.getAttribute("data-astronaut-id") === astronautId &&
                btn.getAttribute("data-mission-id") === missionId) {
                btn.textContent = "ADD TO CREW";
                btn.disabled = false;
                btn.classList.remove('btn-success');
            }
        });
        document.getElementById('btn-clear')?.style.setProperty('display', 'none', 'important');
    }

    function showRisksPopup(button) {
        const missionId = button.getAttribute('data-mission-id');
        const crewSize = parseInt(button.getAttribute('data-crew-size'));

        const viewBtn = button.previousElementSibling;

        if (!missionId) return;

        const crew = getMissionCrew(missionId);
        const requiredSpecializations = getRequiredSpecializations();

        const risks = analyzeCrewRisks(crew, crewSize, requiredSpecializations );
        displayRisksPopup(risks, crew, crewSize);
    }


    function getRequiredSpecializations() {
        const specsText = document.querySelector('p[style*="font-size: 20px"] strong span')?.textContent || '';
        const specs = {};

        if (specsText) {
            specsText.split(',').forEach(item => {
                const match = item.trim().match(/(.+?)\s*-\s*(\d+)/);
                if (match) {
                    const specName = match[1].trim().toLowerCase();
                    const quantity = parseInt(match[2]);
                    specs[specName] = quantity;
                }
            });
        }

        return specs;
    }


    function analyzeCrewRisks(crew, requiredCrewSize, requiredSpecializations ) {
        const risks = {
            crewSizeMatch: crew.length === requiredCrewSize,
            crewCount: crew.length,
            requiredCount: requiredCrewSize,
            specializations: {},
            requiredSpecializations: requiredSpecializations,
            specializationsMismatch: [],
            flightReadiness: [],
            hasErrors: false

        };

        crew.forEach(member => {
            const spec = member.specialization.toLowerCase();
            risks.specializations[spec] = (risks.specializations[spec] || 0) + 1;
        });
        Object.entries(requiredSpecializations).forEach(([spec, required]) => {
            const current = risks.specializations[spec] || 0;
            if (current !== required) {
                risks.specializationsMismatch.push({
                    specialization: spec,
                    required: required,
                    current: current,
                    status: current < required ? 'missing' : 'excess'
                });
            }
        });

        if (!risks.crewSizeMatch ||
            risks.specializationsMismatch.length > 0 ||
            risks.flightReadiness.length > 0) {
            risks.hasErrors = true;
        }

        return risks;
    }
    function displayRisksPopup(risks, crew, requiredCrewSize) {
        const popup = document.getElementById("popup-risks");

        if (!popup) {
            console.error("Popup element not found!");
            return;
        }
        const contentContainer = document.getElementById("risk-analysis-content");

        let content = `
        <div class="risk-analysis">
            <!-- CREW STATUS -->
            <h5 style="color: #00d4ff; margin-bottom: 15px;">üë• CREW STATUS</h5>
            <div style="background: rgba(0, 212, 255, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <p style="margin: 5px 0;">
                    <span style="color: #ffd500;">‚ñ∏</span>
                    Required crew size: <strong>${requiredCrewSize}</strong>
                </p>
                <p style="margin: 5px 0;">
                    <span style="color: #ffd500;">‚ñ∏</span>
                    Current crew size: <strong style="color: ${risks.crewSizeMatch ? '#00ff88' : '#ff6b6b'}">${risks.crewCount}</strong>
                </p>
                ${!risks.crewSizeMatch ?
            `<p style="color: #ff6b6b; margin-top: 10px;">
                        ‚ö†Ô∏è Crew size mismatch! ${risks.crewCount < requiredCrewSize ?
                `Need ${requiredCrewSize - risks.crewCount} more astronaut(s)` :
                `${risks.crewCount - requiredCrewSize} astronaut(s) over limit`}
                    </p>` :
            `<p style="color: #00ff88; margin-top: 10px;">‚úì Crew size is correct!</p>`
        }
            </div>

            <!-- SPECIALIZATIONS -->
            <h5 style="color: #00d4ff; margin-bottom: 15px;">üî¨ SPECIALIZATIONS</h5>
            <div style="background: rgba(0, 212, 255, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                ${Object.keys(risks.requiredSpecializations).length > 0 ?
            Object.entries(risks.requiredSpecializations).map(([spec, required]) => {
                const current = risks.specializations[spec] || 0;
                const isCorrect = current === required;
                return `
                            <p style="margin: 5px 0; color: ${isCorrect ? '#00ff88' : '#ff6b6b'};">
                                <span style="color: #ffd500;">‚ñ∏</span>
                                ${spec.charAt(0).toUpperCase() + spec.slice(1)}:
                                <strong>${current}/${required}</strong>
                                ${isCorrect ? ' ‚úì' : ` ${current < required ? '(need ' + (required - current) + ' more)' : '(excess: ' + (current - required) + ')'}`}
                            </p>
                        `;
            }).join('') :
            '<p style="color: #ff6b6b;">‚ö†Ô∏è No required specializations defined!</p>'
        }

                ${risks.specializationsMismatch.length > 0 ?
            `<p style="color: #ff6b6b; margin-top: 10px; font-weight: bold;">
                        ‚ö†Ô∏è Specialization requirements not met!
                    </p>` :
            Object.keys(risks.requiredSpecializations).length > 0 ?
                `<p style="color: #00ff88; margin-top: 10px; font-weight: bold;">
                            ‚úì All specializations matched!
                        </p>` : ''
        }
            </div>

            <!-- CURRENT CREW MEMBERS -->
            <h5 style="color: #00d4ff; margin-bottom: 15px;">üë®‚ÄçüöÄ CURRENT CREW MEMBERS</h5>
            <div style="max-height: 250px; overflow-y: auto;">
                ${crew.length > 0 ?
            crew.map(member => `
                        <div style="background: rgba(255, 213, 0, 0.1); padding: 12px;
                             border-radius: 8px; margin-bottom: 10px; border-left: 3px solid #ffd500;">
                            <p style="margin: 3px 0; color: #ffd500; font-weight: bold; font-size: 14px;">
                                ${member.firstName.toUpperCase()} ${member.lastName.toUpperCase()}
                            </p>
                            <p style="margin: 3px 0; font-size: 13px;">
                                <span style="color: #00d4ff;">Specialization:</span> ${member.specialization}
                            </p>
                            <p style="margin: 3px 0; font-size: 13px;">
                                <span style="color: #00d4ff;">Health Status:</span>
                                <span style="color: ${(member.healthStatus || '').trim().toUpperCase() === 'FLIGHT READY' ? '#00ff88' : '#ff6b6b'};">
                                    ${member.healthStatus}
                                </span>
                            </p>
                            <p style="margin: 3px 0; font-size: 13px;">
                                <span style="color: #00d4ff;">Overall Score:</span> ${member.overallScore}
                            </p>
                        </div>
                    `).join('') :
            '<p style="color: #ff6b6b; text-align: center; padding: 20px;">No crew members added yet!</p>'
        }
            </div>
        </div>

        <!-- FOOTER -->
        <div class="popup-footer" style="margin-top: 25px; text-align: center; padding-top: 20px; border-top: 1px solid rgba(255, 213, 0, 0.3);">
            ${!risks.hasErrors && crew.length > 0 ?
            `<p style="color: #00ff88; font-size: 18px; font-weight: bold;">
                    ‚úì Mission is ready for launch!
                </p>` :
            `<p style="color: #ff6b6b; font-size: 18px; font-weight: bold;">
                    ‚ö†Ô∏è Mission has critical issues that need to be resolved!
                </p>`
        }
        </div>
    `;

        contentContainer.innerHTML = content;
        popup.style.display = "flex";

        const closeBtn = document.getElementById("popup-risks-close");
        if (closeBtn) {
            closeBtn.onclick = () => popup.style.display = "none";
        }

        popup.onclick = (e) => {
            if (e.target.id === "popup-risks") {
                popup.style.display = "none";
            }
        };

        document.onkeydown = (e) => {
            if (e.key === "Escape") {
                popup.style.display = "none";
            }
        };
    }

    document.getElementById('scrollLeft').addEventListener('click', function () {
        const container = document.getElementById('astronautsScroll');
        container.scrollBy({left: -250, behavior: 'smooth'});
    });

    document.getElementById('scrollRight').addEventListener('click', function () {
        const container = document.getElementById('astronautsScroll');
        container.scrollBy({left: 250, behavior: 'smooth'});
    });


    function showPopup(button) {
        const firstname = button.getAttribute("data-firstname");
        const lastname = button.getAttribute("data-lastname");
        const specialization = button.getAttribute("data-specialization");
        const image = button.getAttribute("data-image");
        const experience = button.getAttribute("data-experience");
        const birthDate = button.getAttribute("data-birthdate");
        const phone = button.getAttribute("data-phone");
        const health = button.getAttribute("data-health");
        const fitness = button.getAttribute("data-fitness");
        const education = button.getAttribute("data-education");
        const psychological = button.getAttribute("data-psychological");
        const overall = button.getAttribute("data-overall");
        const rate = button.getAttribute("data-rate");

        const img = document.getElementById("astronaut-img");
        img.src = image || "";

        document.getElementById("popup-name").textContent = `${firstname || ""} ${lastname || ""}`.trim();
        document.getElementById("popup-specialization").textContent = specialization || "‚Äî";
        document.getElementById("popup-birthDate").textContent = birthDate || "‚Äî";
        document.getElementById("popup-experience").textContent = experience || "0";
        document.getElementById("popup-phone").textContent = phone || "‚Äî";
        document.getElementById("popup-status").textContent = health || "‚Äî";
        document.getElementById("popup-fitness").textContent = fitness || "‚Äî";
        document.getElementById("popup-education").textContent = education || "‚Äî";
        document.getElementById("popup-psychological").textContent = psychological || "‚Äî";
        document.getElementById("popup-overall").textContent = overall || "‚Äî";
        document.getElementById("popup-rate").textContent = rate || "‚Äî";

        const popup = document.getElementById("astronaut-popup");
        popup.style.display = "flex";

        document.getElementById("popup-close").onclick = () => popup.style.display = "none";
        popup.onclick = (e) => {
            if (e.target.id === "astronaut-popup") popup.style.display = "none";
        };
        document.onkeydown = (e) => {
            if (e.key === "Escape") popup.style.display = "none";
        };
    }

    function showAlert(message, type = 'danger') {
        const container = document.getElementById('alert-container');
        const alert = document.createElement('div');
        alert.className = `alert alert-${type} alert-dismissible fade show shadow`;
        alert.role = 'alert';
        alert.innerHTML = `
        <strong>${type === 'success' ? 'Success!' : ''}</strong> ${message}
    `;
        container.appendChild(alert);
        setTimeout(() => alert.remove(), 2000);
    }

</script>
</body>
</html>






<!--
// save progress for mission
function saveMissionProgress(missionId, progressData) {
    let userMissions = getUserMissionData();
    userMissions[`mission_${missionId}_progress`] = {
        ...progressData,
        lastUpdated: new Date().toISOString()
    };
    saveUserMissionData(userMissions);
}

/// get progress for mission
function getMissionProgress(missionId) {
    let userMissions = getUserMissionData();
    return userMissions[`mission_${missionId}_progress`] || null;
}
-->