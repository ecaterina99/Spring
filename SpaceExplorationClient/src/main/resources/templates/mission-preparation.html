<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:insert="~{common_fragments :: head}"></head>
<body>
<div th:insert="~{common_fragments :: mainHeader}"></div>

<div class="budget-container mt-4">
    <div class="budget d-flex justify-content-end align-items-center">
        <h5 class="me-2" style="color: #d6d4d4">CURRENT BUDGET:</h5>
        <p style="color: #ffd500" th:if="${userBudget != null}">
            <span id="currentBudget" style="color: #ffd500"
                  th:text="${userBudget.currentBudget}">0</span> $
        </p>
        <p th:if="${userBudget == null}">
            <span>Not available</span>
        </p>
    </div>

    <div id="budgetChangeNotification" class="budget-notification"></div>

    <div class="budget-bar">
        <div id="budgetProgress" class="budget-progress"></div>
    </div>
</div>


<main class="container py-4 pt-0">

    <section class="mission-participants-text text-md-start mb-4">
        <h1 class="display-5 fw-bold pt-3">
            MISSION PREPARATION FOR
            <span th:text="${mission.name.toUpperCase()}" style="color: #ffd500"></span><br>
        </h1>
        <h2 class="display-7 fw-bold">DESTINATION: <span th:text="${ mission.destinationName.toUpperCase()}"
                                                         style="color: #ffd500"></span></h2>
        <p><span th:text="${mission.code}"></span></p>

        <p class="d-flex pb-3" style="color: #ffffff; line-height: 1.8; margin-top: 10px; font-size: 18px;">
            ❗ Please pay attention to the specializations required for this mission and crew number.<br>
            Meeting all the required specialization and crew requirements greatly
            increases your chances of success.<br>Otherwise, the risk of mission failure will rise.
        </p>
        <p style="font-size: 20px; color: #d9534f"><strong>Required specializations: </strong>
            <strong><span style="color: #ffd500"
                          th:text="${#strings.arrayJoin( mission.specializations.![specialization.displayName + ' - ' + quantity],
    ', ' )}"></span></strong>
        </p>
    </section>

    <!--  Mission details -->
    <section class="mission-participants-container pt-0 pb-3">

        <div class="mission-participants-text text-start mb-4">
            <h2 class="display-7 fw-bold text-glow">CREATE MISSION CREW</h2>
        </div>

        <div class="d-flex align-items-center position-relative">

            <button class="btn btn-light shadow position-absolute start-0 z-3 scroll-btn" id="scrollLeft">
                <i class="bi bi-chevron-left"></i>
            </button>

            <div class="scroll-container d-flex overflow-hidden" id="astronautsScroll">
                <div class="d-flex flex-nowrap gap-4 p-2">

                    <div class="card-participants text-center border-0 flex-shrink-0"
                         style="width: 200px; height: 350px;"
                         th:each="astronaut : ${astronauts}">

                        <div class="card-participants-img text-center border-0 pb-2">
                            <img th:src="@{${astronaut.imageUrl}}" class="mission-participants-card-img-top rounded"
                                 alt="image">
                        </div>

                        <div class="card-participants-body text-center">
                            <h6 class="card-participants-title fw-bold" style="color: #162271;"
                                th:text="${astronaut.firstName.toUpperCase() + astronaut.lastName.toUpperCase()}"></h6>
                            <p class="text-muted"><strong><span th:text="${astronaut.specialization.getDisplayName()}"
                                                                class="text-specialization"></span></strong>
                            </p>
                            <button class="btn hero-btn pt-0 " id="btn-view-participants"
                                    th:attr="data-id=${astronaut.id},
                     data-firstname=${astronaut.firstName},
                     data-lastname=${astronaut.lastName},
                     data-specialization=${astronaut.specialization.getDisplayName().toUpperCase()},
                     data-image=@{${astronaut.imageUrl}},
                     data-experience=${astronaut.yearsOfExperience},
                     data-birthdate=${astronaut.dateOfBirth},
                     data-phone=${astronaut.phone},
                     data-health=${astronaut.healthStatus.getDisplayName()},
                     data-fitness=${astronaut.fitnessScore},
                     data-education=${astronaut.educationScore},
                     data-psychological=${astronaut.psychologicalScore},
                     data-overall=${astronaut.overallScore},
                     data-rate=${astronaut.dailyRate}"
                                    onclick="showPopup(this)">
                                <strong>VIEW DETAILS</strong>
                            </button>
                            <button class="btn hero-btn pt-0 btn-add-participants"
                                    th:attr="data-astronaut-id=${astronaut.id}, data-mission-id=${mission.id}, data-crew-size=${mission.crewSize} ">
                                <strong>ADD TO CREW</strong>
                            </button>
                        </div>
                    </div>
                </div>
            </div>


            <button class="btn btn-light shadow position-absolute end-0 z-3 scroll-btn" id="scrollRight">
                <i class="bi bi-chevron-right"></i>
            </button>

        </div>
    </section>

    <div class="participants-and-risks-container">
        <section class="participants-and-risks">
            <!-- PARTICIPANTS SECTION -->
            <div class="participants">
                <!-- Decorative cosmic dots -->
                <div class="cosmic-dot" style="top: 10%; left: 15%; animation-delay: 0s;"></div>
                <div class="cosmic-dot" style="top: 30%; left: 80%; animation-delay: 1s;"></div>
                <div class="cosmic-dot" style="top: 60%; left: 25%; animation-delay: 2s;"></div>
                <div class="cosmic-dot" style="top: 85%; left: 70%; animation-delay: 1.5s;"></div>

                <h2 class="section-header">⚡ MISSION CREW</h2>


                <div th:if="${#lists.isEmpty(participants)}">
                    <p class="lead" style="color: #fafafa; line-height: 1.8; margin-top: 10px;">
                        No participants assigned yet.<br>
                        Add crew members to begin mission preparation.</p>
                    <br>
                </div>
                <div class="text-center mb-3" id="clear-crew-btn-container" style="display:none;">
                    <button class="btn-clear" onclick="clearCurrentMissionCrew()">
                        <i class="bi bi-trash"></i> Clear All
                    </button>
                </div>
            </div>

            <!-- RISKS SECTION -->
            <div class="risks">
                <h2 class="section-header">⚠️ CHECK MISSION RISKS</h2>

                <div class="risk-info">
                    <div class="risk-info-header d-flex gap-5 justify-content-start align-items-end">
                        <img th:src="@{${mission.imgUrl}}" class="card-image" style="max-height: 170px" alt="image">

                        <div class="risk-issues d-flex justify-content-center flex-column">
                            <strong th:text="${mission.getName()}"></strong>
                            <p style="font-size:16px">
                                Mission Duration:
                                <span th:text="${mission.getDurationDays()}"> </span> days<br>
                                Mission Revenue:
                                <span th:text="${mission.getPaymentAmount()}"></span>$
                            </p>
                            <p style="font-size: 22px">
                                <strong>Potential Issues:</strong>
                            </p>
                        </div>
                    </div>
                    <p style="color: #ffcc80; line-height: 1.8; margin-top: 10px; text-align: justify;">
                        ⚡ <span th:text="${mission.getPotentialIssues()}" class="lead" style="color:#ffd500;"></span>
                    </p>
                </div>

                <div style="text-align: center; margin-top: 25px;">
                    <button class="btn-check-risks"
                            th:attr="data-mission-id=${mission.id},
                 data-crew-size=${mission.crewSize}
                           "
                            onclick="showRisksPopup(this)">
                        ANALYZE RISKS
                    </button>
                </div>
            </div>
        </section>
    </div>


    <!--  Back button -->

    <div class="start-mission d-flex flex-wrap gap-3 justify-content-center ">
        <br>
        <button class="btn-start-mission "
                th:attr="data-mission-id=${mission.id},
                 data-crew-size=${mission.crewSize}"
                onclick="showMissionPopup(this)">
            <span>START MISSION</span>
        </button>
        <br>
    </div>


    <!-- Popup risks-->
   <div id="popup-risks" class="astronaut-popup" style="display:none;">
       <div class="popup-risks-content">

           <div class="header-popup-risks  d-flex flex-row justify-content-sm-between">

               <h3 style="color: #29fff8; margin: 0; padding: 0; font-size: 18px; font-family: 'Orbitron', monospace;  font-weight: bold;">
                   <strong>MISSION RISK ANALYSIS</strong>
               </h3>
               <div class="popup-header" style="position: sticky; top: 0; background: inherit; z-index: 10;
              display: flex; justify-content: end; align-items:end;">
                   <button id="popup-risks-close" style="background: transparent; border: none;
                 color: #29fff8; font-size: 25px; cursor: pointer; line-height: 1;">
                       ×
                   </button>
               </div>
           </div>

           <div id="risk-analysis-content">
           </div>
       </div>
     </div>


     <!-- Popup start mission-->
    <div id="popup-start-mission" class="start-mission-popup">
        <div class="popup-start-mission-content" style=" width:650px; height: 650px">
            <div class="d-flex justify-content-end">
                <button id="popup-mission-close"
                        style="background: transparent; border: none; color: #ff0000;
                     font-size: 30px; cursor: pointer; line-height: 1;">
                    ×
                </button>
            </div>
            <div id="mission-results-content">
            </div>
        </div>
    </div>

    <!-- Popup -->
    <div id="astronaut-popup" class="astronaut-popup" style="display:none;">
        <div class="astronaut-popup-content">
            <span id="popup-close">&times;</span>

            <br>
            <h3 id="popup-title" class="popup-header"><strong>ASTRONAUT BIOGRAPHY</strong></h3>


            <div class="astronaut-top d-flex">
                <div class="astronaut-image">
                    <img id="astronaut-img" class="astronaut-img rounded" alt="astronaut">
                </div>
                <div class="astronaut-main-info">
                    <h3 id="popup-name" class="popup-name"></h3>
                    <p><strong><span id="popup-specialization"></span></strong></p>
                </div>
            </div>

            <div class="astronaut-info row mt-2">
                <div class="col-md-6 score-info-astronaut">
                    <h5 class="popup-subtitle"><strong>MAIN INFO</strong></h5>
                    <p><strong>Date of birth:</strong><span id="popup-birthDate"></span></p>
                    <p><strong>Years of experience:</strong> <span id="popup-experience"></span></p>
                    <p><strong>Status:</strong> <span id="popup-status"></span></p>
                    <p><strong>Daily rate:</strong> <span id="popup-rate"></span></p>
                </div>

                <div class="col-md-6 score-info-astronaut">
                    <h5 class="popup-subtitle"><strong>ASTRONAUT SCORE</strong></h5>
                    <p><strong>Fitness score:</strong> <span id="popup-fitness"></span></p>
                    <p><strong>Education score:</strong> <span id="popup-education"></span></p>
                    <p><strong>Psychological score:</strong> <span id="popup-psychological"></span></p>
                    <p><strong>Overall score:</strong> <span id="popup-overall"></span></p>
                </div>
            </div>

            <div class="text-center mt-1">
            </div>
        </div>
    </div>
</main>
<div id="alert-container" class="position-fixed top-0 start-50 translate-middle-x mt-3" style="z-index: 2000;"></div>

<div th:insert="~{common_fragments :: mainFooter}"></div>
<script th:inline="javascript">
    window.MISSION_CONFIG = {
        accessToken: /*[[${accessToken}]]*/ '',
        userId: /*[[${userId}]]*/ '',
        missionId: /*[[${mission.id}]]*/ null
    };
</script>

<script src="/js/mission-preparation.js"></script>

</body>
</html>
