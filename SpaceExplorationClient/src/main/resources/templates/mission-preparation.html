<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:insert="~{common_fragments :: head}"></head>
<body>
<div th:insert="~{common_fragments :: mainHeader}"></div>

<main class="container py-4">

    <section class="mission-participants-text text-md-start mb-4">
        <h1 class="display-5 fw-bold">
            MISSION PREPARATION FOR
            <span th:text="${mission.name.toUpperCase()}" style="color: #ffd500"></span><br>
        </h1>
        <h2 class="display-7 fw-bold">DESTINATION: <span th:text="${ mission.destinationName.toUpperCase()}"
                                                         style="color: #ffd500"></span></h2>
        <p><span th:text="${mission.code}"></span></p>
        <p style="font-size: 18px;">
            Prepare for your upcoming space mission! Below is the list of crew members and mission details.
        </p>
        <p style="font-size: 18px;"><strong>Required specializations:</strong> <strong><span style="color: #ffd500"
                                                                                             th:text="${#strings.arrayJoin( mission.specializations.![specialization.displayName + ' - ' + quantity],
    ', ' )}"></span></strong></p>
    </section>

    <!--  Mission details -->
    <section class="mission-participants-container pt-0 pb-3">

        <div class="mission-participants-text text-start mb-4">
            <h2 class="display-7 fw-bold text-glow">CREATE MISSION CREW</h2>

        </div>

        <div class="d-flex align-items-center position-relative">

            <button class="btn btn-light shadow position-absolute start-0 z-3 scroll-btn" id="scrollLeft">
                <i class="bi bi-chevron-left"></i>
            </button>

            <div class="scroll-container d-flex overflow-hidden" id="astronautsScroll">
                <div class="d-flex flex-nowrap gap-4 p-2">

                    <div class="card-participants text-center border-0 flex-shrink-0"
                         style="width: 200px; height: 350px;"
                         th:each="astronaut : ${astronauts}">

                        <div class="card-participants-img text-center border-0 pb-2">
                            <img th:src="@{${astronaut.imageUrl}}" class="mission-participants-card-img-top rounded"
                                 alt="image">
                        </div>

                        <div class="card-participants-body text-center">
                            <h6 class="card-participants-title fw-bold" style="color: #162271;"
                                th:text="${astronaut.firstName.toUpperCase() + astronaut.lastName.toUpperCase()}"></h6>
                            <p class="text-muted"><strong><span th:text="${astronaut.specialization.getDisplayName()}"
                                                                class="text-specialization"></span></strong>
                            </p>
                            <button class="btn hero-btn pt-0 " id="btn-view-participants"
                                    th:attr="data-id=${astronaut.id},
                     data-firstname=${astronaut.firstName},
                     data-lastname=${astronaut.lastName},
                     data-specialization=${astronaut.specialization.getDisplayName().toUpperCase()},
                     data-image=@{${astronaut.imageUrl}},
                     data-experience=${astronaut.yearsOfExperience},
                     data-birthdate=${astronaut.dateOfBirth},
                     data-phone=${astronaut.phone},
                     data-health=${astronaut.healthStatus.getDisplayName()},
                     data-fitness=${astronaut.fitnessScore},
                     data-education=${astronaut.educationScore},
                     data-psychological=${astronaut.psychologicalScore},
                     data-overall=${astronaut.overallScore},
                     data-rate=${astronaut.dailyRate}"
                                    onclick="showPopup(this)">
                                <strong>VIEW DETAILS</strong>
                            </button>
                            <button class="btn hero-btn pt-0 btn-add-participants"
                                    th:attr="data-astronaut-id=${astronaut.id}, data-mission-id=${mission.id}, data-crew-size=${mission.crewSize}">
                                <strong>ADD TO CREW</strong>
                            </button>
                        </div>
                    </div>
                </div>
            </div>


            <button class="btn btn-light shadow position-absolute end-0 z-3 scroll-btn" id="scrollRight">
                <i class="bi bi-chevron-right"></i>
            </button>

        </div>
    </section>

    <div class="participants-and-risks-container">
        <section class="participants-and-risks">
            <!-- PARTICIPANTS SECTION -->
            <div class="participants">
                <!-- Decorative cosmic dots -->
                <div class="cosmic-dot" style="top: 10%; left: 15%; animation-delay: 0s;"></div>
                <div class="cosmic-dot" style="top: 30%; left: 80%; animation-delay: 1s;"></div>
                <div class="cosmic-dot" style="top: 60%; left: 25%; animation-delay: 2s;"></div>
                <div class="cosmic-dot" style="top: 85%; left: 70%; animation-delay: 1.5s;"></div>

                <h2 class="section-header">⚡ MISSION CREW</h2>

                <div th:if="${#lists.isEmpty(participants)}">
                    <p class="lead mt-4">No participants assigned yet.<br>
                        Add crew members to begin mission preparation.</p>

                </div>

             <!--   <div th:if="${!#lists.isEmpty(participants)}" class="added-crew-card d-flex flex-wrap gap-3">
                    <div th:each="p : ${participants}" class="added-crew-card  p-3 flex-fill text-center">
                        <h5 class="fw-bold" style="color:#ffd500;" th:text="${p.astronautName}"></h5>
                        <p><span style="color: #00d4ff;">▸</span> Specialization: <span style="color: white;"
                                                                                        th:text="${p.specialization.toLowerCase()}"></span>
                        </p>
                        <span class="score">Overall score: <span th:text="${p.overallScore}"></span></span>

                    </div>

                </div> -->
            </div>

            <!-- RISKS SECTION -->
            <div class="risks">
                <h2 class="section-header">⚠️ CHECK MISSION RISKS</h2>

                <div class="risk-info">
                    <div class="risk-info-header d-flex gap-3 justify-content-start pb-0">
                        <img th:src="@{${mission.imgUrl}}" class="card-image" alt="image">
                    </div>
                    <p style="margin-top: 25px;">
                        <strong>Potential Issues:</strong>
                    </p>

                    <p style="color: #ffcc80; line-height: 1.8; margin-top: 10px;">
                        ⚡ <span th:text="${mission.getPotentialIssues()}" style="color:#ffd500;"></span>
                    </p>

                </div>

                <div style="text-align: center; margin-top: 40px;">
                    <button class="btn-check-risks">
                        ANALYZE RISKS
                    </button>
                </div>
            </div>
        </section>
    </div>

    <!--  Back button -->
    <div class="start-mission d-flex flex-wrap gap-3 justify-content-center ">
        <button class="btn-start-mission ">
            START MISSION
        </button>
    </div>


    <!-- Popup -->
    <div id="astronaut-popup" class="astronaut-popup" style="display:none;">
        <div class="astronaut-popup-content">
            <span id="popup-close">&times;</span>

            <br>
            <h3 id="popup-title" class="popup-header"><strong>ASTRONAUT BIOGRAPHY</strong></h3>


            <div class="astronaut-top d-flex">
                <div class="astronaut-image">
                    <img id="astronaut-img" class="astronaut-img rounded" alt="astronaut">
                </div>
                <div class="astronaut-main-info">
                    <h3 id="popup-name" class="popup-name"></h3>
                    <p><strong><span id="popup-specialization"></span></strong></p>
                </div>
            </div>

            <div class="astronaut-info row mt-2">
                <div class="col-md-6 score-info-astronaut">
                    <h5 class="popup-subtitle"><strong>MAIN INFO</strong></h5>
                    <p><strong>Date of birth:</strong><span id="popup-birthDate"></span></p>
                    <p><strong>Years of experience:</strong> <span id="popup-experience"></span></p>
                    <p><strong>Phone:</strong> <span id="popup-phone"></span></p>
                    <p><strong>Status:</strong> <span id="popup-status"></span></p>
                    <p><strong>Daily rate:</strong> <span id="popup-rate"></span></p>
                </div>

                <div class="col-md-6 score-info-astronaut">
                    <h5 class="popup-subtitle"><strong>ASTRONAUT SCORE</strong></h5>
                    <p><strong>Fitness score:</strong> <span id="popup-fitness"></span></p>
                    <p><strong>Education score:</strong> <span id="popup-education"></span></p>
                    <p><strong>Psychological score:</strong> <span id="popup-psychological"></span></p>
                    <p><strong>Overall score:</strong> <span id="popup-overall"></span></p>
                </div>
            </div>

            <div class="text-center mt-1">
                <button id="downloadBtn" class="btn btn-outline-info btn-sm">
                    DOWNLOAD BIOGRAPHY
                </button>

            </div>
        </div>
    </div>
</main>
<div id="alert-container" class="position-fixed top-0 start-50 translate-middle-x mt-3" style="z-index: 2000;"></div>

<div th:insert="~{common_fragments :: mainFooter}"></div>

<script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', () => {
        /*<![CDATA[*/
        const accessToken = /*[[${accessToken}]]*/ '';
        /*]]>*/

        if (accessToken) {
            sessionStorage.setItem('accessToken', accessToken);
        }
        if (!sessionStorage.getItem('allMissionCrews')) {
            sessionStorage.setItem('allMissionCrews', JSON.stringify({}));
        }

        displayCurrentCrew();
        displayCrewMembers();
    });


    document.querySelectorAll(".btn-add-participants").forEach(btn => {
        btn.addEventListener("click", () => {
            const astronautId = btn.getAttribute("data-astronaut-id");
            const missionId = btn.getAttribute("data-mission-id");
            const crewSize = btn.getAttribute("data-crew-size");

            let allCrews = JSON.parse(sessionStorage.getItem('allMissionCrews') || '{}');
            let currentMissionCrew = allCrews[missionId] || [];

            if (currentMissionCrew.some(member => member.astronautId === astronautId)) {
                showAlert("This astronaut is already in the crew!", "warning");
                return;
            }

            if (currentMissionCrew.length >= crewSize) {
                showAlert("Mission crew is full!", "warning");
                return;
            }

            const viewBtn = btn.previousElementSibling;

            currentMissionCrew.push({
                astronautId: astronautId,
                missionId: missionId,
                firstName: viewBtn.getAttribute('data-firstname') || '',
                lastName: viewBtn.getAttribute('data-lastname') || '',
                specialization: viewBtn.getAttribute('data-specialization') || '',
                imageUrl: viewBtn.getAttribute('data-image') || '',
                overallScore: viewBtn.getAttribute('data-overall') || '0'
            });

            allCrews[missionId] = currentMissionCrew;
            sessionStorage.setItem('allMissionCrews', JSON.stringify(allCrews));

            btn.textContent = "ADDED ✓";
            btn.disabled = true;
            btn.classList.add('btn-success');

            showAlert("Astronaut added to crew!", "success");
            displayCurrentCrew();
            displayCrewMembers();

        });
    });


    function displayCurrentCrew() {
        const missionId = document.querySelector('.btn-add-participants')?.getAttribute('data-mission-id');
        if (!missionId) {
            console.warn('Mission ID not found');
            return;
        }
        let allCrews = JSON.parse(sessionStorage.getItem('allMissionCrews') || '{}');
        const currentMissionCrew = allCrews[missionId] || [];

        console.log('Current mission crew:', currentMissionCrew);
        console.log('Mission ID:', missionId);

        const crewCount = document.getElementById('crew-count');
        if (crewCount) {
            crewCount.textContent = `Crew members: ${currentMissionCrew.length}`;
        }
        document.querySelectorAll(".btn-add-participants").forEach(btn => {
            const astronautId = btn.getAttribute("data-astronaut-id");
            const isAdded = currentMissionCrew.some(member => member.astronautId === astronautId);

            if (isAdded) {
                btn.textContent = "ADDED ✓";
                btn.disabled = true;
                btn.classList.add('btn-success');
            }
        });
    }

    function displayCrewMembers() {
        const missionId = document.querySelector('.btn-add-participants')?.getAttribute('data-mission-id');
        if (!missionId) return;

        const crew = getMissionCrew(missionId);
        const participantsDiv = document.querySelector('.participants');

        // find containers
        let emptyMessageDiv = participantsDiv.querySelector('div[th\\:if]') ||
            participantsDiv.querySelector('.lead')?.parentElement;
        let crewCardsContainer = participantsDiv.querySelector('.added-crew-card');

        if (crew.length === 0) {
            //show message "No participants"
            if (crewCardsContainer) {
                crewCardsContainer.style.display = 'none';
            }
            if (emptyMessageDiv) {
                emptyMessageDiv.style.display = 'block';
            }
            return;
        }

        // hide message "No participants"
        if (emptyMessageDiv) {
            emptyMessageDiv.style.display = 'none';
        }

        //cards container
        if (!crewCardsContainer) {
            const header = participantsDiv.querySelector('.section-header');
            crewCardsContainer = document.createElement('div');
            crewCardsContainer.className = 'added-crew-card d-flex flex-wrap gap-3';
            header.after(crewCardsContainer);
        } else {
            crewCardsContainer.style.display = 'flex';
        }
        const clearBtnContainer = document.getElementById('clear-crew-btn-container');
        if (clearBtnContainer) {
            clearBtnContainer.style.display = crew.length > 0 ? 'block' : 'none';
        }

        //html
        crewCardsContainer.innerHTML = crew.map(member => `
        <div class="added-crew-card p-3 flex-fill text-center position-relative">
            <button class="btn btn-sm btn-danger position-absolute top-0 end-0 m-2"
                    onclick="removeFromCrew('${member.astronautId}', '${missionId}')"
                    style="padding: 2px 8px; font-size: 12px; z-index: 10;">
                <i class="bi bi-x-lg"></i>
            </button>
            <h5 class="fw-bold" style="color:#ffd500;">
                ${member.firstName.toUpperCase()} ${member.lastName.toUpperCase()}
            </h5>
            <p>
                <span style="color: #00d4ff;">▸</span>
                Specialization:
                <span style="color: white;">${member.specialization.toLowerCase()}</span>
            </p>
            <span class="score">Overall score: <span>${member.overallScore}</span></span>
        </div>
          <div class="text-center mb-3" style="display: none;" id="clear-crew-btn-container">
                            <button class="btn btn-outline-danger btn-sm" onclick="clearCurrentMissionCrew()">
                                <i class="bi bi-trash"></i> Clear All Crew
                            </button>
                        </div>
    `).join('');
    }


    function getMissionCrew(missionId) {
        let allCrews = JSON.parse(sessionStorage.getItem('allMissionCrews') || '{}');
        return allCrews[missionId] || [];
    }

    function clearCurrentMissionCrew() {
        const missionId = document.querySelector('.btn-add-participants')?.getAttribute('data-mission-id');
        if (!missionId) {
            showAlert("Mission ID not found!", "danger");
            return;
        }

        if (confirm('Are you sure you want to clear the entire crew?')) {
            clearMissionCrew(missionId);

            // unblock all buttons
            document.querySelectorAll(".btn-add-participants").forEach(btn => {
                btn.textContent = "ADD TO CREW";
                btn.disabled = false;
                btn.classList.remove('btn-success');
            });

            showAlert("Crew cleared successfully!", "info");
        }
    }
    function clearMissionCrew(missionId) {
        let allCrews = JSON.parse(sessionStorage.getItem('allMissionCrews') || '{}');
        delete allCrews[missionId];
        sessionStorage.setItem('allMissionCrews', JSON.stringify(allCrews));
        displayCurrentCrew();
        displayCrewMembers();
    }

    function removeFromCrew(astronautId, missionId) {
        let allCrews = JSON.parse(sessionStorage.getItem('allMissionCrews') || '{}');
        let currentMissionCrew = allCrews[missionId] || [];

        currentMissionCrew = currentMissionCrew.filter(member => member.astronautId !== astronautId);
        allCrews[missionId] = currentMissionCrew;

        sessionStorage.setItem('allMissionCrews', JSON.stringify(allCrews));

        displayCurrentCrew();
        displayCrewMembers(); 
        showAlert("Astronaut removed from crew", "info");

        // Снимаем блокировку с кнопки
        document.querySelectorAll(".btn-add-participants").forEach(btn => {
            if (btn.getAttribute("data-astronaut-id") === astronautId &&
                btn.getAttribute("data-mission-id") === missionId) {
                btn.textContent = "ADD TO CREW";
                btn.disabled = false;
                btn.classList.remove('btn-success');
            }
        });
    }

    function logout() {
        sessionStorage.removeItem('accessToken');
        sessionStorage.removeItem('allMissionCrews');
    }

    document.getElementById('scrollLeft').addEventListener('click', function () {
        const container = document.getElementById('astronautsScroll');
        container.scrollBy({left: -250, behavior: 'smooth'});
    });

    document.getElementById('scrollRight').addEventListener('click', function () {
        const container = document.getElementById('astronautsScroll');
        container.scrollBy({left: 250, behavior: 'smooth'});
    });

    function showPopup(button) {
        const firstname = button.getAttribute("data-firstname");
        const lastname = button.getAttribute("data-lastname");
        const specialization = button.getAttribute("data-specialization");
        const image = button.getAttribute("data-image");
        const experience = button.getAttribute("data-experience");
        const birthDate = button.getAttribute("data-birthdate");
        const phone = button.getAttribute("data-phone");
        const health = button.getAttribute("data-health");
        const fitness = button.getAttribute("data-fitness");
        const education = button.getAttribute("data-education");
        const psychological = button.getAttribute("data-psychological");
        const overall = button.getAttribute("data-overall");
        const rate = button.getAttribute("data-rate");

        const img = document.getElementById("astronaut-img");
        img.src = image || "";

        document.getElementById("popup-name").textContent = `${firstname || ""} ${lastname || ""}`.trim();
        document.getElementById("popup-specialization").textContent = specialization || "—";
        document.getElementById("popup-birthDate").textContent = birthDate || "—";
        document.getElementById("popup-experience").textContent = experience || "0";
        document.getElementById("popup-phone").textContent = phone || "—";
        document.getElementById("popup-status").textContent = health || "—";
        document.getElementById("popup-fitness").textContent = fitness || "—";
        document.getElementById("popup-education").textContent = education || "—";
        document.getElementById("popup-psychological").textContent = psychological || "—";
        document.getElementById("popup-overall").textContent = overall || "—";
        document.getElementById("popup-rate").textContent = rate || "—";

        const popup = document.getElementById("astronaut-popup");
        popup.style.display = "flex";

        document.getElementById("popup-close").onclick = () => popup.style.display = "none";
        popup.onclick = (e) => {
            if (e.target.id === "astronaut-popup") popup.style.display = "none";
        };
        document.onkeydown = (e) => {
            if (e.key === "Escape") popup.style.display = "none";
        };
    }

    function showAlert(message, type = 'danger') {
        const container = document.getElementById('alert-container');
        const alert = document.createElement('div');
        alert.className = `alert alert-${type} alert-dismissible fade show shadow`;
        alert.role = 'alert';
        alert.innerHTML = `
        <strong>${type === 'success' ? 'Success!' : ''}</strong> ${message}
    `;
        container.appendChild(alert);
        setTimeout(() => alert.remove(), 2000);
    }

</script>
</body>
</html>


<!--
console.log('Access token from Thymeleaf:', accessToken);
console.log('Token length:', accessToken.length);

if (accessToken) {
sessionStorage.setItem('accessToken', accessToken);
console.log('Token initialized successfully');
} else {
console.warn('Access token is empty!');
}
});
*/
/*
document.querySelectorAll(".btn-add-participants").forEach(btn => {
btn.addEventListener("click", async () => {
const astronautId = btn.getAttribute("data-astronaut-id");
const missionId = btn.getAttribute("data-mission-id");

const token = sessionStorage.getItem('accessToken');

if (!token) {
showAlert("Authorization token is missing!", "danger");
console.error('Token not found in sessionStorage');
return;
}

if (!missionId || !astronautId) {
showAlert("Missing mission or astronaut ID!", "danger");
console.error('Missing IDs:', {missionId, astronautId});
return;
}

try {
const serverUrl = "http://localhost:8080/api";
const response = await fetch(`${serverUrl}/mission-participants/add/${missionId}/${astronautId}`, {
method: "POST",
headers: {
'Accept': 'application/json',
'Authorization': `Bearer ${token}`,
'Content-Type': 'application/json'
}
});

if (response.ok) {
showAlert("Astronaut added to crew successfully!", "success");
setTimeout(() => location.reload(), 1500);
} else {
let errorData;
try {
errorData = await response.json();
} catch {
const text = await response.text();
errorData = {message: text};
}

console.error('Server error:', errorData);

if (errorData.error === "CREW_OVERFLOW") {
showAlert(`Mission crew is full!`, "warning");
} else if (errorData.error === "VALIDATION_ERROR") {
showAlert(errorData.message, "warning");
} else if (errorData.error === "Resource not found") {
showAlert(errorData.message, "warning");
} else {
showAlert(errorData.message || "An unknown error occurred.", "warning");
}
}
} catch (err) {
console.error("Error adding astronaut:", err);
showAlert("Network error. Please try again.", "danger");
}
});
});
-->