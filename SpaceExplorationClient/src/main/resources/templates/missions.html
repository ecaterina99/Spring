<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:insert="~{common_fragments :: head}"></head>
<body>
<div th:insert="~{common_fragments :: mainHeader}"></div>

<main class="container">
    <section class="intro container py-5 pb-0 text-md-start">
        <h1 class="title-astronauts display-5 fw-bold text-glow">ACROSS THE UNIVERSE: MISSIONS AWAIT</h1>
        <h6 class="title-astronauts display-6 fw-bold " style="color: #005bb6">Select your next adventure.</h6>
        <br>
        <p class="lead pb-0" style="font-size: 17px; line-height: 1.8;">
            Cosmic missions represent humanityâ€™s bold steps into the vastness of space,
            each with unique challenges and goals.<br>Together, these missions push the boundaries of exploration and
            prepare us for the future of interstellar
            travel.<br>Every destination brings its own level of difficulty, from harsh
            radiation to extreme distances.
        </p>
    </section>

    <section class="container pt-0 pb-5">
        <div class="filter-card d-flex justify-content-end align-items-end">
            <form th:action="@{/missions}" method="get">
                <div class="form-grid">
                    <div class="form-group">
                        <div class="form-check">
                            <select class="form-select" name="difficultyLevel" id="select-difficulty">
                                <option value="">All Levels</option>
                                <option value="LOW"
                                        th:selected="${filterCriteria?.difficultyLevel == 'LOW'}">Low
                                </option>
                                <option value="MEDIUM"
                                        th:selected="${filterCriteria?.difficultyLevel == 'MEDIUM'}">Medium
                                </option>
                                <option value="HIGH"
                                        th:selected="${filterCriteria?.difficultyLevel == 'HIGH'}">High
                                </option>
                                <option value="EXTREME"
                                        th:selected="${filterCriteria?.difficultyLevel == 'EXTREME'}">Extreme
                                </option>
                            </select>
                        </div>
                        <div class="form-check">
                            <select class="form-select" name="destinationId" id="select-destination">
                                <option value="">All Destinations</option>
                                <option th:each="dest : ${destinations}"
                                        th:value="${dest.key}"
                                        th:text="${dest.value}"
                                        th:selected="${filterCriteria?.destinationId == dest.key}">
                                </option>
                            </select>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </section>

    <section class="container pt-0 pb-5">
        <div id="missions-container" th:insert="~{mission-cards :: missionCards}"></div>
    </section>
</main>

<div th:insert="~{popup-mission :: mission-popup}"></div>
<div th:insert="~{popup-mission :: mission-popup-script}"></div>


<script>
    const mapLevelToClass = {
        'LOW': 'level-low',
        'MEDIUM': 'level-medium',
        'HIGH': 'level-high',
        'EXTREME': 'level-extreme'
    };

    function applyLevelBadges() {
        document.querySelectorAll('.card-level').forEach(el => {
            const raw = el.dataset.level || '';
            const level = raw.trim().toUpperCase();
            el.classList.remove('level-low', 'level-medium', 'level-high', 'level-extreme', 'level-default');
            const cls = mapLevelToClass[level] || 'level-default';
            el.classList.add(cls);
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        applyLevelBadges();

        const difficultySelect = document.querySelector("[name='difficultyLevel']");
        const destinationSelect = document.querySelector("[name='destinationId']");
        let missionsContainer = document.getElementById("missions-container");

        async function fetchMissions() {
            const params = new URLSearchParams();
            if (difficultySelect.value) params.append("difficultyLevel", difficultySelect.value);
            if (destinationSelect.value) params.append("destinationId", destinationSelect.value);

            try {
                const response = await fetch(`/api/missions/filter-fragment?${params.toString()}`);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                missionsContainer.innerHTML = await response.text();
                applyLevelBadges();

            } catch (error) {
                console.error("Error fetching missions:", error);
            }
        }

        difficultySelect.addEventListener("change", fetchMissions);
        destinationSelect.addEventListener("change", fetchMissions);
    });
</script>

<div th:insert="~{common_fragments :: mainFooter}"></div>

</body>
</html>
