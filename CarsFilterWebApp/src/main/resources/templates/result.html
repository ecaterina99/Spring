<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Search Results - Car Filter Application</title>
    <link rel="stylesheet" th:href="@{/style.css}">
</head>
<body>
<!-- Header -->
<header class="header">
    <div class="container">
        <div class="header-content">
            <h1 class="header-title">Car Filter Application</h1>
            <a href="/cars/" class="btn btn-secondary">Back to Search</a>
        </div>
    </div>
</header>

<main class="container">
    <!-- Error Message -->
    <div th:if="${error}" class="alert alert-error">
        <span th:text="${error}">Error message</span>
        <button type="button" class="alert-close" onclick="this.parentElement.remove()">Ã—</button>
    </div>

    <!-- Filter Summary -->
    <section th:if="${criteria?.active}" class="filter-summary">
        <h2 class="summary-title">Applied Filters</h2>
        <div class="summary-content">
            <p th:text="${criteria.filterDescription}">Filter description</p>
            <div class="filter-tags">
                    <span class="filter-tag" th:if="${criteria.hasManufacturerFilter()}">
                        <span th:text="${criteria.manufacturer}">Manufacturer</span>
                    </span>
                <span class="filter-tag" th:if="${criteria.hasYearFilter()}">
                        <span th:text="${criteria.minYear > 0 and criteria.maxYear > 0 ? criteria.minYear + '-' + criteria.maxYear :
                                       criteria.minYear > 0 ? 'From ' + criteria.minYear : 'Up to ' + criteria.maxYear}">Year Range</span>
                    </span>
                <span class="filter-tag" th:if="${criteria.hasConsumptionFilter()}">
                        <span th:text="${criteria.consumption.displayName}">Consumption Type</span>
                    </span>
            </div>
        </div>
    </section>

    <!-- Results Section -->
    <section class="results-section">
        <div class="results-header">
            <h2 class="results-title">Search Results</h2>
            <div class="results-count" th:text="${totalCount + ' cars found'}">0 cars found</div>
        </div>

        <!-- Cars Grid -->
        <div class="cars-grid" th:if="${totalCount > 0}">
            <article class="car-card" th:each="car : ${cars}">
                <div class="car-image" th:attr="aria-label='Car image for ' + ${car.manufacturer} + ' ' + ${car.model}"></div>
                <div class="car-info">
                    <h3 class="car-name" th:text="${car.manufacturer + ' ' + car.model}">Car Name</h3>
                    <p class="car-year" th:text="'Year: ' + ${car.productionYear}">Year</p>

                    <div class="car-consumption">
                            <span class="consumption-badge"
                                  th:classappend="${car.consumption?.name() == 'ELECTRIC' ? 'badge-electric' :
                                                 car.consumption?.name() == 'FUEL' ? 'badge-fuel' : 'badge-hybrid'}"
                                  th:text="${car.consumption}">Consumption</span>
                    </div>

                    <div class="car-details">
                        <div class="car-detail" th:if="${car.horsepower > 0}">
                            <span th:text="${car.horsepower + ' HP'}">HP</span>
                        </div>
                        <div class="car-detail" th:if="${car.price > 0}">
                            <span th:text="'$' + ${car.price}">Price</span>
                        </div>
                        <div class="car-detail" th:if="${car.consumptionValue > 0 and car.consumption?.name() != 'ELECTRIC'}">
                            <span th:text="${car.consumptionValue + ' L/100km'}">Consumption</span>
                        </div>
                    </div>

                    <div class="car-id" th:if="${car.id}">
                        <small class="text-muted">ID: <span th:text="${car.id}">Car ID</span></small>
                    </div>
                </div>
            </article>
        </div>

        <!-- No Results -->
        <div th:if="${totalCount == 0}" class="no-results">
            <h3>No cars found</h3>
            <p>No cars match your current filter criteria.</p>
            <div class="no-results-actions">
                <a href="/cars/" class="btn btn-primary">New Search</a>
            </div>
        </div>
    </section>

    <!-- Export Options -->
    <section th:if="${totalCount > 0}" class="export-section">
        <h3 class="export-title">Export Results</h3>
        <div class="export-buttons">
            <button class="btn btn-outline" onclick="exportController.exportToCSV()" aria-label="Export results to CSV">
                Export to CSV
            </button>
            <button class="btn btn-outline" onclick="exportController.printResults()" aria-label="Print results">
                Print Results
            </button>
        </div>
    </section>
</main>

<script>
    class ExportController {
        constructor() {
            this.cars = this.extractCarsData();
        }

        extractCarsData() {
            const carCards = document.querySelectorAll('.car-card');
            const cars = [];

            carCards.forEach(card => {
                const car = {
                    id: this.extractText(card, '.car-id span'),
                    manufacturer: this.extractManufacturer(card),
                    model: this.extractModel(card),
                    productionYear: this.extractYear(card),
                    horsepower: this.extractHorsepower(card),
                    price: this.extractPrice(card),
                    consumption: this.extractText(card, '.consumption-badge'),
                    consumptionValue: this.extractConsumptionValue(card)
                };
                cars.push(car);
            });

            return cars;
        }

        extractText(element, selector) {
            const target = element.querySelector(selector);
            return target ? target.textContent.trim() : '';
        }

        extractManufacturer(card) {
            const name = this.extractText(card, '.car-name');
            return name.split(' ')[0] || '';
        }

        extractModel(card) {
            const name = this.extractText(card, '.car-name');
            return name.split(' ').slice(1).join(' ') || '';
        }

        extractYear(card) {
            const yearText = this.extractText(card, '.car-year');
            return yearText.replace('Year: ', '');
        }

        extractHorsepower(card) {
            const details = card.querySelectorAll('.car-detail');
            for (const detail of details) {
                const text = detail.textContent.trim();
                if (text.includes('HP')) {
                    return text.replace(' HP', '');
                }
            }
            return '';
        }

        extractPrice(card) {
            const details = card.querySelectorAll('.car-detail');
            for (const detail of details) {
                const text = detail.textContent.trim();
                if (text.includes('$')) {
                    return text.replace('$', '');
                }
            }
            return '';
        }

        extractConsumptionValue(card) {
            const details = card.querySelectorAll('.car-detail');
            for (const detail of details) {
                const text = detail.textContent.trim();
                if (text.includes('L/100km')) {
                    return text.replace(' L/100km', '');
                }
            }
            return '';
        }

        exportToCSV() {
            if (this.cars.length === 0) {
                alert('No data to export');
                return;
            }

            const headers = ['ID', 'Manufacturer', 'Model', 'Year', 'Horsepower', 'Price', 'Consumption Type', 'Consumption Value'];
            let csvContent = headers.join(',') + '\n';

            this.cars.forEach(car => {
                const row = [
                    car.id,
                    car.manufacturer,
                    car.model,
                    car.productionYear,
                    car.horsepower,
                    car.price,
                    car.consumption,
                    car.consumptionValue
                ].map(field => `"${field}"`).join(',');
                csvContent += row + '\n';
            });

            this.downloadFile(csvContent, 'car_search_results.csv', 'text/csv');
        }

        downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');

            link.href = url;
            link.download = filename;
            link.style.display = 'none';

            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            URL.revokeObjectURL(url);
        }

        printResults() {
            const printStyle = document.createElement('style');
            printStyle.textContent = `
                    @media print {
                        .header, .export-section { display: none; }
                        .car-card { break-inside: avoid; margin-bottom: 1rem; }
                        .cars-grid { grid-template-columns: 1fr; }
                    }
                `;
            document.head.appendChild(printStyle);

            window.print();

            setTimeout(() => {
                document.head.removeChild(printStyle);
            }, 1000);
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        window.exportController = new ExportController();
    });
</script>
</body>
</html>